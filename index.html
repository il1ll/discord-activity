<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Discord Activity</title>
    <link rel="icon" type="image/png" href="https://i.postimg.cc/LXrBqy0Z/1721359673085-2.jpg">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/devicons/devicon@v2.15.1/devicon.min.css">
    <style>
        .top-bar {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            background: #1a1a1a;
            border-bottom: 1px solid #2a2a2a;
            padding: 12px 15px;
            display: flex;
            gap: 10px;
            align-items: center;
            z-index: 1000;
        }
        .user-input {
            flex: 1;
            background: #2a2a2a;
            border: 1px solid #3a3a3a;
            border-radius: 8px;
            padding: 10px 12px;
            color: white;
            font-size: 14px;
            outline: none;
            transition: border-color 0.2s;
            min-width: 0;
        }
        .user-input:focus {
            border-color: #7289da;
        }
        .submit-btn {
            background: #7289da;
            border: none;
            border-radius: 8px;
            padding: 10px 16px;
            color: white;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s;
            white-space: nowrap;
            flex-shrink: 0;
        }
        .submit-btn:hover {
            background: #5b73c4;
        }
        @media (max-width: 480px) {
            .top-bar {
                padding: 10px 12px;
            }
        }
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a1a 100%);
            color: #f0f0f0;
            min-height: 100vh;
            padding: 80px 20px 20px 20px;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .container {
            display: flex;
            flex-direction: column;
            gap: 15px;
            width: 448px;
        }
        .profile-banner {
            width: 100%;
            height: 120px;
            border-radius: 15px 15px 0 0;
            object-fit: cover;
            display: none;
        }
        .profile-banner-gif {
            width: 100%;
            height: 120px;
            border-radius: 15px 15px 0 0;
            object-fit: cover;
            display: none;
        }
        .color-banner {
            width: 100%;
            height: 120px;
            border-radius: 15px 15px 0 0;
            display: none;
        }
        .profile-card {
            background: #1a1a1a;
            border-radius: 0 0 15px 15px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
            border: 1px solid #2a2a2a;
            position: relative;
            overflow: hidden;
            width: 100%;
            height: 84px;
        }
        .profile-header {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 8px 15px;
            width: 100%;
            height: 100%;
            position: relative;
            overflow: hidden;
            isolation: isolate;
        }
        .nameplate-video {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            z-index: 0;
        }
        .avatar-container {
            position: relative;
            width: 52px;
            height: 52px;
            flex-shrink: 0;
            z-index: 1;
        }
        .avatar {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
        }
        .avatar-gif {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
            display: none;
        }
        .status-indicator {
            position: absolute;
            bottom: 0;
            right: 0;
            width: 14px;
            height: 14px;
            border-radius: 50%;
            border: 3px solid #1a1a1a;
        }
        .status-dnd { background-color: #ed4245; }
        .status-online { background-color: #3ba55c; }
        .status-idle { background-color: #faa81a; }
        .status-offline { background-color: #747f8d; }
        .avatar-decoration {
            position: absolute;
            top: -6px;
            left: -6px;
            width: 64px;
            height: 64px;
            pointer-events: none;
            z-index: 1;
        }
        .user-info {
            flex: 1;
            min-width: 0;
            z-index: 1;
        }
        .name-container {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .display-name {
            font-size: 16px;
            font-weight: 700;
            color: white;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .tag-container {
            display: flex;
            align-items: center;
            gap: 4px;
            background: #2a2a2a;
            border-radius: 5px;
            padding: 3px 6px;
            font-size: 11px;
            font-weight: 600;
            color: #b9bbbe;
            flex-shrink: 0;
        }
        .tag-icon {
            width: 12px;
            height: 12px;
            border-radius: 2px;
        }
        .device-icons {
            display: flex;
            gap: 3px;
            flex-shrink: 0;
        }
        .device-icon {
            width: 12px;
            height: 12px;
        }
        .device-icon.dnd { color: #ed4245; }
        .device-icon.online { color: #3ba55c; }
        .device-icon.idle { color: #faa81a; }
        .device-icon.offline { color: #747f8d; }
        #tagInfo:empty,
        #deviceIcons:empty {
            display: none;
        }
        .badges-container {
            display: flex;
            gap: 2px;
            flex-shrink: 0;
        }
        .badge-icon {
            width: 16px;
            height: 16px;
            border-radius: 2px;
        }
        .username-row {
            display: flex;
            align-items: center;
            min-width: 0;
            color: rgba(255, 255, 255, 0.6);
            font-size: 12px;
            margin-top: 2px;
        }
        .username {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            flex-shrink: 0;
        }
        .status-separator {
            margin: 0 4px;
            display: none; 
            flex-shrink: 0;
        }
        .custom-status {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            display: flex;
            align-items: center;
            gap: 4px;
            min-width: 0; 
            flex-shrink: 1;
        }
        .custom-status-emoji {
            width: 16px;
            height: 16px;
            object-fit: contain;
            vertical-align: middle;
            flex-shrink: 0;
        }
        .spotify-card {
            border-radius: 12px;
            padding: 15px;
            width: 100%;
            display: none;
            background: #1a1a1a;
            border: 1px solid #2a2a2a;
        }
        .spotify-card {
            order: -2;
        }
        .spotify-active {
            display: block;
            animation: fadeIn 0.3s ease;
        }
        .spotify-header {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-bottom: 12px;
        }
        .spotify-logo {
            width: 14px;
            height: 14px;
        }
        .spotify-title {
            font-weight: 700;
            font-size: 12px;
            color: #b9bbbe;
            text-transform: uppercase;
        }
        .spotify-content {
            display: flex;
            gap: 12px;
            align-items: center;
        }
        .album-art {
            width: 50px;
            height: 50px;
            border-radius: 6px;
            object-fit: cover;
        }
        .track-info {
            flex: 1;
            min-width: 0;
        }
        .track-name {
            font-weight: 600;
            margin-bottom: 4px;
            font-size: 14px;
            color: white;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .track-artist {
            color: #b9bbbe;
            font-size: 12px;
            margin-bottom: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .progress-container {
            width: 100%;
            height: 3px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 2px;
            overflow: hidden;
            margin-top: 6px;
        }
        .progress-bar {
            height: 100%;
            background: #7289da;
            border-radius: 2px;
            width: 0%;
            transition: width 0.1s linear;
        }
        .time-info {
            display: flex;
            justify-content: space-between;
            font-size: 11px;
            color: #b9bbbe;
            margin-top: 4px;
        }
        .activities-container {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        #activitiesContainer:empty {
            display: none;
        }
        .activity-card {
            border-radius: 12px;
            padding: 15px;
            width: 100%;
            display: none;
            background: #1a1a1a;
            border: 1px solid #2a2a2a;
        }
        .activity-card {
            order: -1;
        }
        .activity-active {
            display: block;
            animation: fadeIn 0.3s ease;
        }
        .activity-header {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-bottom: 12px;
        }
        .activity-icon {
            width: 14px;
            height: 14px;
        }
        .activity-title {
            font-weight: 700;
            font-size: 12px;
            color: #b9bbbe;
            text-transform: uppercase;
        }
        .activity-content {
            display: flex;
            gap: 12px;
            align-items: center;
        }
        .activity-image-container {
            position: relative;
            width: 50px;
            height: 50px;
            flex-shrink: 0;
        }
        .activity-large-image {
            width: 100%;
            height: 100%;
            border-radius: 6px;
            object-fit: cover;
        }
        .activity-small-image {
            position: absolute;
            bottom: -4px;
            right: -4px;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 2px solid #1a1a1a;
            object-fit: cover;
        }
        .activity-info {
            flex: 1;
            min-width: 0;
        }
        .activity-name {
            font-weight: 600;
            margin-bottom: 4px;
            font-size: 14px;
            color: white;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .activity-details {
            color: #b9bbbe;
            font-size: 12px;
            margin-bottom: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .activity-state {
            color: #b9bbbe;
            font-size: 12px;
            margin-bottom: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .activity-time {
            display: flex;
            align-items: center;
            gap: 4px;
            color: #b9bbbe;
            font-size: 11px;
            margin-top: 4px;
        }
        .time-icon {
            width: 10px;
            height: 10px;
        }
        .activity-progress {
            display: none;
        }
        .activity-buttons {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-top: 12px;
        }
        .activity-buttons:empty {
            display: none;
        }
        .activity-button {
            background: #2a2a2a;
            border: none;
            border-radius: 14px;
            padding: 10px 16px;
            color: white;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            transition: background-color 0.2s;
            text-decoration: none;
            width: 100%;
            height: 36px;
        }
        .activity-button:hover {
            background: #363636;
        }
        .button-icon {
            width: 14px;
            height: 14px;
        }
        .spotify-button-icon {
            color: #1db954;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .error {
            text-align: center;
            padding: 20px;
            color: #ed4245;
            font-size: 14px;
        }
        @media (max-width: 768px) {
            .container {
                width: 100%;
                max-width: 400px;
            }
        }
        .toast {
            position: fixed;
            top: 80px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #ed4245;
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            z-index: 2000;
            font-size: 14px;
            font-weight: 500;
            opacity: 0;
            transition: opacity 0.3s ease, top 0.3s ease;
            display: none;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }
        .toast.show {
            display: block;
            opacity: 1;
            top: 90px;
        }
    </style>
</head>
<body>
    <div class="top-bar">
        <input type="text" class="user-input" id="userIdInput" placeholder="Enter User ID">
        <button class="submit-btn" id="submitBtn">Load</button>
    </div>
    <div class="container">
        <div id="spotifyCard" class="spotify-card">
            <div class="spotify-header">
                <svg class="spotify-logo" viewBox="0 0 496 512" fill="#1db954">
                    <path d="M248 8C111.1 8 0 119.1 0 256s111.1 248 248 248 248-111.1 248-248S384.9 8 248 8zm100.7 364.9c-4.2 0-6.8-1.3-10.7-3.6-62.4-37.6-135-39.2-206.7-24.5-3.9 1-9 2.6-11.9 2.6-9.7 0-15.8-7.7-15.8-15.8 0-10.3 6.1-15.2 13.6-16.8 81.9-18.1 165.6-16.5 237 26.2 6.1 3.9 9.7 7.4 9.7 16.5s-7.1 15.4-15.2 15.4zm26.9-65.6c-5.2 0-8.7-2.3-12.3-4.2-62.5-37-155.7-51.9-238.6-29.4-4.8 1.3-7.4 2.6-11.9 2.6-10.7 0-19.4-8.7-19.4-19.4s5.2-17.8 15.5-20.7c27.8-7.8 56.2-13.6 97.8-13.6 64.9 0 127.6 16.1 177 45.5 8.1 4.8 11.3 11 11.3 19.7-.1 10.8-8.5 19.5-19.4 19.5zm31-76.2c-5.2 0-8.4-1.3-12.9-3.9-71.2-42.5-198.5-52.7-280.9-29.7-3.6 1-8.1 2.6-12.9 2.6-13.2 0-23.3-10.3-23.3-23.6 0-13.6 8.4-21.3 17.4-23.9 35.2-10.3 74.6-15.2 117.5-15.2 73 0 149.5 15.2 205.4 47.8 7.8 4.5 12.9 10.7 12.9 22.6 0 13.6-11 23.3-23.2 23.3z"/>
                </svg>
                <div class="spotify-title">Listening to Spotify</div>
            </div>
            <div class="spotify-content">
                <img id="albumArt" class="album-art" src="" alt="Album Art">
                <div class="track-info">
                    <div class="track-name" id="trackName"></div>
                    <div class="track-artist" id="trackArtist"></div>
                    <div class="progress-container">
                        <div class="progress-bar" id="progressBar"></div>
                    </div>
                    <div class="time-info">
                        <span id="currentTime">0:00</span>
                        <span id="totalTime">0:00</span>
                    </div>
                </div>
            </div>
            <div class="activity-buttons" id="spotifyButtons"></div>
        </div>
        <div id="activitiesContainer" class="activities-container"></div>
        <div class="profile-section">
            <img id="profileBanner" class="profile-banner" src="" alt="Profile Banner">
            <img id="profileBannerGif" class="profile-banner-gif" src="" alt="Profile Banner GIF">
            <div id="colorBanner" class="color-banner"></div>
            <div class="profile-card" id="profileCard">
                <div class="profile-header" id="profileHeader">
                    <video id="nameplateVideo" class="nameplate-video" autoplay loop muted playsinline style="display: none;"></video>
                    <div class="avatar-container">
                        <img id="avatar" class="avatar" src="" alt="Avatar" style="display: none;">
                        <img id="avatarGif" class="avatar-gif" src="" alt="Avatar GIF" style="display: none;">
                        <div id="statusIndicator" class="status-indicator"></div>
                        <img id="avatarDecoration" class="avatar-decoration" src="" alt="Decoration" style="display: none;">
                    </div>
                    <div class="user-info">
                        <div class="name-container">
                            <div class="display-name" id="displayName"></div>
                            <div id="tagInfo"></div>
                            <div class="device-icons" id="deviceIcons"></div>
                            <div class="badges-container" id="badgesContainer"></div>
                        </div>
                        <div class="username-row">
                            <div class="username" id="username"></div>
                            <div class="status-separator" id="statusSeparator" style="display: none;">â€¢</div>
                            <div class="custom-status" id="customStatus"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div id="errorToast" class="toast"></div>
    <script>
        let currentUserId = '1099039269391171765';
        const CdnBaseUrl = 'https://cdn.discordapp.com/';
        const IconPaths = {
            desktop: "M4 2.5c-1.103 0-2 .897-2 2v11c0 1.104.897 2 2 2h7v2H7v2h10v-2h-4v-2h7c1.103 0 2-.896 2-2v-11c0-1.103-.897-2-2-2H4Zm16 2v9H4v-9h16Z",
            web: "M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2Zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93Zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39Z",
            mobile: "M15.5 1h-8A2.5 2.5 0 0 0 5 3.5v17A2.5 2.5 0 0 0 7.5 23h8a2.5 2.5 0 0 0 2.5-2.5v-17A2.5 2.5 0 0 0 15.5 1zm-4 21c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zm4.5-4H7V4h9v14z",
            embedded: "M5.79335761,5 L18.2066424,5 C19.7805584,5 21.0868816,6.21634264 21.1990185,7.78625885 L21.8575059,17.0050826 C21.9307825,18.0309548 21.1585512,18.9219909 20.132679,18.9952675 C20.088523,18.9984215 20.0442685,19 20,19 C18.8245863,19 17.8000084,18.2000338 17.5149287,17.059715 L17,15 L7,15 L6.48507125,17.059715 C6.19999155,18.2000338 5.1754137,19 4,19 C2.97151413,19 2.13776159,18.1662475 2.13776159,17.1377616 C2.13776159,17.0934931 2.1393401,17.0492386 2.1424941,17.0050826 L2.80098151,7.78625885 C2.91311838,6.21634264 4.21944161,5 5.79335761,5 Z M14.5,10 C15.3284271,10 16,9.32842712 16,8.5 C16,7.67157288 15.3284271,7 14.5,7 C13.6715729,7 13,7.67157288 13,8.5 C13,9.32842712 13.6715729,10 14.5,10 Z M18.5,13 C19.3284271,13 20,12.3284271 20,11.5 C20,10.6715729 19.3284271,10 18.5,10 C17.6715729,10 17,10.6715729 17,11.5 C17,12.3284271 17.6715729,13 18.5,13 Z M6,9 L4,9 L4,11 L6,11 L6,13 L8,13 L8,11 L10,11 L10,9 L8,9 L8,7 L6,7 L6,9 ZM5.79335761,5 L18.2066424,5 C19.7805584,5 21.0868816,6.21634264 21.1990185,7.78625885 L21.8575059,17.0050826 C21.9307825,18.0309548 21.1585512,18.9219909 20.132679,18.9952675 C20.088523,18.9984215 20.0442685,19 20,19 C18.8245863,19 17.8000084,18.2000338 17.5149287,17.059715 L17,15 L7,15 L6.48507125,17.059715 C6.19999155,18.2000338 5.1754137,19 4,19 C2.97151413,19 2.13776159,18.1662475 2.13776159,17.1377616 C2.13776159,17.0934931 2.1393401,17.0492386 2.1424941,17.0050826 L2.80098151,7.78625885 C2.91311838,6.21634264 4.21944161,5 5.79335761,5 Z M14.5,10 C15.3284271,10 16,9.32842712 16,8.5 C16,7.67157288 15.3284271,7 14.5,7 C13.6715729,7 13,7.67157288 13,8.5 C13,9.32842712 13.6715729,10 14.5,10 Z M18.5,13 C19.3284271,13 20,12.3284271 20,11.5 C20,10.6715729 19.3284271,10 18.5,10 C17.6715729,10 17,10.6715729 17,11.5 C17,12.3284271 17.6715729,13 18.5,13 Z M6,9 L4,9 L4,11 L6,11 L6,13 L8,13 L8,11 L10,11 L10,9 L8,9 L8,7 L6,7 L6,9 Z",
        };
        let progressInterval;
        let currentStatus = '';
        let socket = null;
        let heartbeatInterval = null;
        let activityIntervals = {};
        let lastCustomStatus = null;
        let lastActivities = [];
        let lastSpotifyData = null;
        let toastTimeout = null;

        function showErrorToast(message) {
            const toast = document.getElementById('errorToast');
            if (!toast) return;
            toast.textContent = message;
            toast.classList.add('show');
            if (toastTimeout) {
                clearTimeout(toastTimeout);
            }
            toastTimeout = setTimeout(() => {
                toast.classList.remove('show');
            }, 1000);
        }

        async function fetchDcdnData(userId) {
            const DcdnUrl = `https://dcdn.dstn.to/profile/${userId}`;
            const response = await fetch(DcdnUrl);
            if (!response.ok) {
                throw new Error('User not found');
            }
            const data = await response.json();
            if (data.user) {
                updateBanner(data.user, userId);
                updateBadges(data.badges);
            } else {
                throw new Error('Invalid user data');
            }
        }

        function updateBanner(userData, userId) {
            const bannerElement = document.getElementById('profileBanner');
            const bannerGifElement = document.getElementById('profileBannerGif');
            const colorBannerElement = document.getElementById('colorBanner');
            bannerElement.style.display = 'none';
            bannerGifElement.style.display = 'none';
            colorBannerElement.style.display = 'none';
            if (userData.banner) {
                if (userData.banner.startsWith('a_')) {
                    const gifUrl = `${CdnBaseUrl}banners/${userId}/${userData.banner}.gif?size=480`;
                    bannerGifElement.src = gifUrl;
                    bannerGifElement.style.display = 'block';
                } else {
                    const pngUrl = `${CdnBaseUrl}banners/${userId}/${userData.banner}.png?size=480`;
                    bannerElement.src = pngUrl;
                    bannerElement.style.display = 'block';
                }
            } else if (userData.banner_color || userData.accent_color) {
                const color = userData.banner_color || `#${userData.accent_color.toString(16).padStart(6, '0')}`;
                colorBannerElement.style.backgroundColor = color;
                colorBannerElement.style.display = 'block';
            }
        }

        function updateBadges(badges) {
            const badgesContainer = document.getElementById('badgesContainer');
            badgesContainer.innerHTML = '';
            if (badges && badges.length > 0) {
                badges.forEach(badge => {
                    if (badge.icon) {
                        const badgeImg = document.createElement('img');
                        badgeImg.className = 'badge-icon';
                        badgeImg.src = `${CdnBaseUrl}badge-icons/${badge.icon}.png`;
                        badgeImg.alt = badge.description || 'Badge';
                        badgeImg.title = badge.description || '';
                        badgesContainer.appendChild(badgeImg);
                    }
                });
            }
        }

        function connectWebSocket(userId) {
            try {
                if (socket) {
                    socket.onopen = null;
                    socket.onmessage = null;
                    socket.onclose = null;
                    socket.onerror = null;
                    socket.close();
                    if (heartbeatInterval) clearInterval(heartbeatInterval);
                }
                socket = new WebSocket('wss://api.lanyard.rest/socket');
                socket.addEventListener('open', () => {
                    console.log('WebSocket connected');
                });
                socket.addEventListener('message', event => {
                    const message = JSON.parse(event.data);
                    switch(message.op) {
                        case 1: handleHello(message, userId); break;
                        case 0: handleEvent(message); break;
                    }
                });
                socket.addEventListener('close', () => {
                    console.log('WebSocket disconnected');
                    if (heartbeatInterval) clearInterval(heartbeatInterval);
                });
                socket.addEventListener('error', () => {
                    console.error('WebSocket error');
                });
            } catch (error) {
                console.error('Failed to connect WebSocket:', error);
            }
        }

        function handleHello(message, userId) {
            const interval = message.d.heartbeat_interval;
            if (heartbeatInterval) clearInterval(heartbeatInterval);
            heartbeatInterval = setInterval(() => {
                if (socket && socket.readyState === WebSocket.OPEN) socket.send(JSON.stringify({ op: 3 }));
            }, interval);
            initializeConnection(userId);
        }

        function initializeConnection(userId) {
            if (socket && socket.readyState === WebSocket.OPEN) {
                socket.send(JSON.stringify({ op: 2, d: { subscribe_to_id: userId } }));
            }
        }

        function handleEvent(message) {
            if (['INIT_STATE', 'PRESENCE_UPDATE'].includes(message.t)) {
                const userData = message.d;
                updateProfile(userData);
                updateNameplateBackground(userData);
                updateTagInfo(userData);
                
                const customStatusChanged = updateCustomStatus(userData.activities);
                
                const spotifyChanged = updateSpotifyIfChanged(userData);
                
                if (!customStatusChanged || spotifyChanged || hasOtherActivityChanges(userData.activities)) {
                    updateActivities(userData.activities);
                }
            }
        }

        function hasOtherActivityChanges(newActivities) {
            const newOtherActivities = newActivities ? newActivities.filter(activity => 
                activity.type !== 4 && activity.name !== 'Spotify'
            ) : [];
            
            const oldOtherActivities = lastActivities.filter(activity => 
                activity.type !== 4 && activity.name !== 'Spotify'
            );
            
            if (newOtherActivities.length !== oldOtherActivities.length) return true;
            
            for (let i = 0; i < newOtherActivities.length; i++) {
                const newActivity = newOtherActivities[i];
                const oldActivity = oldOtherActivities[i];
                
                if (!oldActivity || 
                    newActivity.name !== oldActivity.name ||
                    newActivity.details !== oldActivity.details ||
                    newActivity.state !== oldActivity.state) {
                    return true;
                }
            }
            
            return false;
        }

        function updateSpotifyIfChanged(userData) {
            const currentSpotifyData = userData.listening_to_spotify && userData.spotify ? userData.spotify : null;
            
            const spotifyChanged = JSON.stringify(currentSpotifyData) !== JSON.stringify(lastSpotifyData);
            
            if (spotifyChanged) {
                lastSpotifyData = currentSpotifyData;
                
                if (userData.listening_to_spotify && userData.spotify) {
                    updateSpotify(userData.spotify);
                } else {
                    const spotifyCard = document.getElementById('spotifyCard');
                    spotifyCard.classList.remove('spotify-active');
                    if (progressInterval) clearInterval(progressInterval);
                }
            }
            
            return spotifyChanged;
        }

        function updateProfile(userData) {
            const discordUser = userData.discord_user;
            const avatarElement = document.getElementById('avatar');
            const avatarGifElement = document.getElementById('avatarGif');
            const avatarDecorationElement = document.getElementById('avatarDecoration');
            avatarElement.style.display = 'none';
            avatarGifElement.style.display = 'none';
            let avatarUrl;
            if (discordUser.avatar && discordUser.avatar.startsWith('a_')) {
                avatarUrl = `${CdnBaseUrl}avatars/${discordUser.id}/${discordUser.avatar}.gif?size=256`;
                avatarGifElement.src = avatarUrl;
                avatarGifElement.style.display = 'block';
            } else if (discordUser.avatar) {
                avatarUrl = `${CdnBaseUrl}avatars/${discordUser.id}/${discordUser.avatar}.png?size=256`;
                avatarElement.src = avatarUrl;
                avatarElement.style.display = 'block';
            } else {
                avatarUrl = `${CdnBaseUrl}embed/avatars/${discordUser.discriminator % 5}.png`;
                avatarElement.src = avatarUrl;
                avatarElement.style.display = 'block';
            }
            if (discordUser.avatar_decoration_data) {
                avatarDecorationElement.style.display = 'block';
                avatarDecorationElement.src = `${CdnBaseUrl}avatar-decoration-presets/${discordUser.avatar_decoration_data.asset}.png`;
            } else {
                avatarDecorationElement.style.display = 'none';
                avatarDecorationElement.src = '';
            }
            const displayName = discordUser.global_name || discordUser.username;
            document.getElementById('displayName').textContent = displayName;
            document.getElementById('username').textContent = `@${discordUser.username}`;
            updateStatus(userData.discord_status);
            updateDeviceIcons(userData);
        }

        function updateNameplateBackground(userData) {
            const nameplateData = userData.discord_user?.collectibles?.nameplate;
            const profileHeader = document.getElementById('profileHeader');
            const nameplateVideo = document.getElementById('nameplateVideo');
            if (nameplateData && nameplateData.asset) {
                const videoUrl = `${CdnBaseUrl}assets/collectibles/${nameplateData.asset}asset.webm`;
                nameplateVideo.src = videoUrl;
                nameplateVideo.style.display = 'block';
                profileHeader.style.backgroundColor = 'transparent';
                profileHeader.style.backgroundImage = 'none';
            } else {
                nameplateVideo.src = '';
                nameplateVideo.style.display = 'none';
                profileHeader.style.backgroundColor = '#1a1a1a';
                profileHeader.style.backgroundImage = 'none';
            }
        }

        function updateTagInfo(userData) {
            const primaryGuild = userData.discord_user?.primary_guild;
            const tagInfoElement = document.getElementById('tagInfo');
            tagInfoElement.innerHTML = '';
            if (primaryGuild && primaryGuild.tag && primaryGuild.badge && primaryGuild.identity_guild_id) {
                const badgeUrl = `${CdnBaseUrl}clan-badges/${primaryGuild.identity_guild_id}/${primaryGuild.badge}.png?size=16`;
                const tagContainer = document.createElement('div');
                tagContainer.className = 'tag-container';
                const tagImage = document.createElement('img');
                tagImage.className = 'tag-icon';
                tagImage.src = badgeUrl;
                tagImage.alt = 'Tag Icon';
                const tagText = document.createElement('span');
                tagText.textContent = primaryGuild.tag;
                tagContainer.appendChild(tagImage);
                tagContainer.appendChild(tagText);
                tagInfoElement.appendChild(tagContainer);
            }
        }

        function updateStatus(status) {
            currentStatus = status;
            const indicator = document.getElementById('statusIndicator');
            indicator.className = 'status-indicator';
            switch(status) {
                case 'dnd': indicator.classList.add('status-dnd'); break;
                case 'online': indicator.classList.add('status-online'); break;
                case 'idle': indicator.classList.add('status-idle'); break;
                default: indicator.classList.add('status-offline');
            }
        }

        function updateDeviceIcons(userData) {
            const deviceIcons = document.getElementById('deviceIcons');
            deviceIcons.innerHTML = '';
            const devices = [];
            if (userData.active_on_discord_desktop) devices.push('desktop');
            if (userData.active_on_discord_mobile) devices.push('mobile');
            if (userData.active_on_discord_web) devices.push('web');
            if (userData.active_on_discord_embedded) devices.push('embedded');
            devices.forEach(device => {
                const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
                svg.setAttribute('class', `device-icon ${currentStatus}`);
                svg.setAttribute('viewBox', '0 0 24 24');
                svg.setAttribute('fill', 'currentColor');
                const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                path.setAttribute('d', IconPaths[device]);
                svg.appendChild(path);
                deviceIcons.appendChild(svg);
            });
        }

        function updateSpotify(spotifyData) {
            const spotifyCard = document.getElementById('spotifyCard');
            spotifyCard.classList.add('spotify-active');
            document.getElementById('albumArt').src = spotifyData.album_art_url;
            document.getElementById('trackName').textContent = spotifyData.song;
            document.getElementById('trackArtist').textContent = `by ${spotifyData.artist}`;
            const startTime = spotifyData.timestamps.start;
            const endTime = spotifyData.timestamps.end;
            const duration = endTime - startTime;
            if (progressInterval) clearInterval(progressInterval);
            function updateProgress() {
                const now = Date.now();
                const elapsed = now - startTime;
                const progress = Math.min((elapsed / duration) * 100, 100);
                document.getElementById('progressBar').style.width = `${progress}%`;
                const currentMinutes = Math.floor(elapsed / 60000);
                const currentSeconds = Math.floor((elapsed % 60000) / 1000);
                const totalMinutes = Math.floor(duration / 60000);
                const totalSeconds = Math.floor((duration % 60000) / 1000);
                document.getElementById('currentTime').textContent = `${currentMinutes}:${currentSeconds.toString().padStart(2, '0')}`;
                document.getElementById('totalTime').textContent = `${totalMinutes}:${totalSeconds.toString().padStart(2, '0')}`;
                if (progress >= 100) clearInterval(progressInterval);
            }
            updateProgress();
            progressInterval = setInterval(updateProgress, 100);
            const spotifyButtons = document.getElementById('spotifyButtons');
            spotifyButtons.innerHTML = '';
            const spotifyButton = document.createElement('a');
            spotifyButton.className = 'activity-button';
            spotifyButton.href = spotifyData.track_id ? `https://open.spotify.com/track/${spotifyData.track_id}` : '#';
            spotifyButton.target = '_blank';
            const spotifyIcon = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
            spotifyIcon.setAttribute('class', 'button-icon spotify-button-icon');
            spotifyIcon.setAttribute('viewBox', '0 0 496 512');
            spotifyIcon.setAttribute('fill', 'currentColor');
            const spotifyPath = document.createElementNS('http://www.w3.org/2000/svg', 'path');
            spotifyPath.setAttribute('d', "M248 8C111.1 8 0 119.1 0 256s111.1 248 248 248 248-111.1 248-248S384.9 8 248 8zm100.7 364.9c-4.2 0-6.8-1.3-10.7-3.6-62.4-37.6-135-39.2-206.7-24.5-3.9 1-9 2.6-11.9 2.6-9.7 0-15.8-7.7-15.8-15.8 0-10.3 6.1-15.2 13.6-16.8 81.9-18.1 165.6-16.5 237 26.2 6.1 3.9 9.7 7.4 9.7 16.5s-7.1 15.4-15.2 15.4zm26.9-65.6c-5.2 0-8.7-2.3-12.3-4.2-62.5-37-155.7-51.9-238.6-29.4-4.8 1.3-7.4 2.6-11.9 2.6-10.7 0-19.4-8.7-19.4-19.4s5.2-17.8 15.5-20.7c27.8-7.8 56.2-13.6 97.8-13.6 64.9 0 127.6 16.1 177 45.5 8.1 4.8 11.3 11 11.3 19.7-.1 10.8-8.5 19.5-19.4 19.5zm31-76.2c-5.2 0-8.4-1.3-12.9-3.9-71.2-42.5-198.5-52.7-280.9-29.7-3.6 1-8.1 2.6-12.9 2.6-13.2 0-23.3-10.3-23.3-23.6 0-13.6 8.4-21.3 17.4-23.9 35.2-10.3 74.6-15.2 117.5-15.2 73 0 149.5 15.2 205.4 47.8 7.8 4.5 12.9 10.7 12.9 22.6 0 13.6-11 23.3-23.2 23.3z");
            spotifyIcon.appendChild(spotifyPath);
            spotifyButton.appendChild(spotifyIcon);
            spotifyButton.appendChild(document.createTextNode('Play on Spotify'));
            spotifyButtons.appendChild(spotifyButton);
        }

        function updateCustomStatus(activities) {
            const customStatusElement = document.getElementById('customStatus');
            const separatorElement = document.getElementById('statusSeparator');
            const usernameElement = document.getElementById('username');
            const customStatus = activities ? activities.find(activity => activity.type === 4) : null;
            
            const currentStatusKey = customStatus ? JSON.stringify({
                emoji: customStatus.emoji,
                state: customStatus.state
            }) : null;
            
            if (currentStatusKey === lastCustomStatus) {
                return false;
            }
            
            lastCustomStatus = currentStatusKey;
            
            if (!customStatus) {
                customStatusElement.innerHTML = '';
                separatorElement.style.display = 'none';
                return true;
            }
            
            customStatusElement.innerHTML = '';
            let hasStatusContent = false;
            
            if (customStatus.emoji) {
                if (customStatus.emoji.id) {
                    const extension = customStatus.emoji.animated ? 'gif' : 'png';
                    const emojiUrl = `https://cdn.discordapp.com/emojis/${customStatus.emoji.id}.${extension}`;
                    const emojiImg = document.createElement('img');
                    emojiImg.src = emojiUrl;
                    emojiImg.alt = "emoji";
                    emojiImg.className = "custom-status-emoji";
                    customStatusElement.appendChild(emojiImg);
                    hasStatusContent = true;
                } else if (customStatus.emoji.name) {
                    const emojiSpan = document.createElement('span');
                    emojiSpan.textContent = customStatus.emoji.name;
                    customStatusElement.appendChild(emojiSpan);
                    hasStatusContent = true;
                }
            }
            
            if (customStatus.state) {
                const textSpan = document.createElement('span');
                textSpan.textContent = customStatus.state;
                textSpan.style.whiteSpace = 'nowrap';
                textSpan.style.overflow = 'hidden';
                textSpan.style.textOverflow = 'ellipsis';
                customStatusElement.appendChild(textSpan);
                hasStatusContent = true;
            }
            
            const hasUsernameContent = usernameElement.textContent.trim() !== '';
            if (hasUsernameContent && hasStatusContent) {
                separatorElement.style.display = 'block';
            } else {
                separatorElement.style.display = 'none';
            }
            
            return true;
        }

        function updateActivities(activities) {
            lastActivities = activities ? [...activities] : [];
            
            const activitiesContainer = document.getElementById('activitiesContainer');
            activitiesContainer.innerHTML = '';
            const validActivities = activities ? activities.filter(activity => 
                activity.type !== 4 && activity.name !== 'Spotify'
            ) : [];
            
            validActivities.forEach((activity, index) => {
                const activityCard = document.createElement('div');
                activityCard.className = 'activity-card activity-active';
                activityCard.id = `activityCard-${index}`;
                
                let activityTitleText = '';
                switch (activity.type) {
                    case 0: activityTitleText = 'Playing'; break;
                    case 1: activityTitleText = 'Streaming'; break;
                    case 2: activityTitleText = 'Listening to'; break;
                    case 3: activityTitleText = 'Watching'; break;
                    case 5: activityTitleText = 'Competing in'; break;
                    default: activityTitleText = 'Active in';
                }
                
                if (activity.platform && activity.type === 0) {
                    activityTitleText += ` ${activity.platform}`;
                }
                
                activityCard.innerHTML = `
                    <div class="activity-header">
                        <svg class="activity-icon" viewBox="0 0 24 24" fill="#b9bbbe">
                            <path d="M5.79335761,5 L18.2066424,5 C19.7805584,5 21.0868816,6.21634264 21.1990185,7.78625885 L21.8575059,17.0050826 C21.9307825,18.0309548 21.1585512,18.9219909 20.132679,18.9952675 C20.088523,18.9984215 20.0442685,19 20,19 C18.8245863,19 17.8000084,18.2000338 17.5149287,17.059715 L17,15 L7,15 L6.48507125,17.059715 C6.19999155,18.2000338 5.1754137,19 4,19 C2.97151413,19 2.13776159,18.1662475 2.13776159,17.1377616 C2.13776159,17.0934931 2.1393401,17.0492386 2.1424941,17.0050826 L2.80098151,7.78625885 C2.91311838,6.21634264 4.21944161,5 5.79335761,5 Z M14.5,10 C15.3284271,10 16,9.32842712 16,8.5 C16,7.67157288 15.3284271,7 14.5,7 C13.6715729,7 13,7.67157288 13,8.5 C13,9.32842712 13.6715729,10 14.5,10 Z M18.5,13 C19.3284271,13 20,12.3284271 20,11.5 C20,10.6715729 19.3284271,10 18.5,10 C17.6715729,10 17,10.6715729 17,11.5 C17,12.3284271 17.6715729,13 18.5,13 Z M6,9 L4,9 L4,11 L6,11 L6,13 L8,13 L8,11 L10,11 L10,9 L8,9 L8,7 L6,7 L6,9 Z"/>
                        </svg>
                        <div class="activity-title">${activityTitleText}</div>
                    </div>
                    <div class="activity-content">
                        <div class="activity-image-container">
                            <img class="activity-large-image" src="" alt="Activity">
                            <img class="activity-small-image" src="" alt="Small Icon" style="display: none;">
                        </div>
                        <div class="activity-info">
                            <div class="activity-name">${activity.name}</div>
                            <div class="activity-details">${activity.details || ''}</div>
                            <div class="activity-state">${activity.state || ''}</div>
                            <div class="activity-time" style="display: none;">
                                <svg class="time-icon" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8z"/>
                                    <path d="M12.5 7H11v6l5.25 3.15.75-1.23-4.5-2.67z"/>
                                </svg>
                                <span class="activity-time-text">0:00:00</span>
                            </div>
                            <div class="activity-progress" style="display: none;">
                                <div class="progress-container">
                                    <div class="progress-bar"></div>
                                </div>
                                <div class="time-info">
                                    <span class="activity-current-time">0:00</span>
                                    <span class="activity-end-time">0:00</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="activity-buttons"></div>
                `;
                const largeImageElement = activityCard.querySelector('.activity-large-image');
                const smallImageElement = activityCard.querySelector('.activity-small-image');
                
                if (activity.assets) {
                    if (activity.assets.large_image) {
                        let largeImageUrl = activity.assets.large_image;
                        if (largeImageUrl.startsWith('mp:')) {
                            largeImageUrl = `https://media.discordapp.net/${largeImageUrl.replace('mp:', '')}`;
                        } else if (largeImageUrl.startsWith('spotify:')) {
                            largeImageUrl = `https://i.scdn.co/image/${largeImageUrl.replace('spotify:', '')}`;
                        } else if (largeImageUrl.startsWith('external:')) {
                            largeImageUrl = largeImageUrl.replace('external:', '');
                        } else if (largeImageUrl.startsWith('https%3A%2F%2F')) {
                            largeImageUrl = decodeURIComponent(largeImageUrl);
                        } else {
                            largeImageUrl = `https://cdn.discordapp.com/app-assets/${activity.application_id}/${largeImageUrl}.png?size=512`;
                        }
                        largeImageElement.src = largeImageUrl;
                    } else if (activity.assets.small_image) {
                        let smallImageUrl = activity.assets.small_image;
                        if (smallImageUrl.startsWith('mp:')) {
                            smallImageUrl = `https://media.discordapp.net/${smallImageUrl.replace('mp:', '')}`;
                        } else if (smallImageUrl.startsWith('spotify:')) {
                            smallImageUrl = `https://i.scdn.co/image/${smallImageUrl.replace('spotify:', '')}`;
                        } else if (smallImageUrl.startsWith('external:')) {
                            smallImageUrl = smallImageUrl.replace('external:', '');
                        } else {
                            smallImageUrl = `https://cdn.discordapp.com/app-assets/${activity.application_id}/${smallImageUrl}.png?size=512`;
                        }
                        largeImageElement.src = smallImageUrl;
                    }
                    
                    if (activity.assets.small_image && activity.assets.large_image) {
                        let smallImageUrl = activity.assets.small_image;
                        if (smallImageUrl.startsWith('mp:')) {
                            smallImageUrl = `https://media.discordapp.net/${smallImageUrl.replace('mp:', '')}`;
                        } else if (smallImageUrl.startsWith('spotify:')) {
                            smallImageUrl = `https://i.scdn.co/image/${smallImageUrl.replace('spotify:', '')}`;
                        } else if (smallImageUrl.startsWith('external:')) {
                            smallImageUrl = smallImageUrl.replace('external:', '');
                        } else {
                            smallImageUrl = `https://cdn.discordapp.com/app-assets/${activity.application_id}/${smallImageUrl}.png?size=128`;
                        }
                        smallImageElement.src = smallImageUrl;
                        smallImageElement.style.display = 'block';
                    }
                } else if (activity.application_id) {
                    largeImageElement.src = `https://dcdn.dstn.to/app-icons/${activity.application_id}.png?size=512`;
                }
                
                const activityTimeElement = activityCard.querySelector('.activity-time');
                const activityProgressElement = activityCard.querySelector('.activity-progress');
                if (activity.timestamps && activity.timestamps.start && activity.timestamps.end) {
                    activityTimeElement.style.display = 'none';
                    activityProgressElement.style.display = 'block';
                    const startTime = activity.timestamps.start;
                    const endTime = activity.timestamps.end;
                    const duration = endTime - startTime;
                    function updateActivityProgress() {
                        const now = Date.now();
                        const elapsed = now - startTime;
                        const progress = Math.min((elapsed / duration) * 100, 100);
                        activityProgressElement.querySelector('.progress-bar').style.width = `${progress}%`;
                        const currentMinutes = Math.floor(elapsed / 60000);
                        const currentSeconds = Math.floor((elapsed % 60000) / 1000);
                        const totalMinutes = Math.floor(duration / 60000);
                        const totalSeconds = Math.floor((duration % 60000) / 1000);
                        activityProgressElement.querySelector('.activity-current-time').textContent = `${currentMinutes}:${currentSeconds.toString().padStart(2, '0')}`;
                        activityProgressElement.querySelector('.activity-end-time').textContent = `${totalMinutes}:${totalSeconds.toString().padStart(2, '0')}`;
                        if (progress >= 100) clearInterval(activityIntervals[activity.id]);
                    }
                    if (activityIntervals[activity.id]) clearInterval(activityIntervals[activity.id]);
                    updateActivityProgress();
                    activityIntervals[activity.id] = setInterval(updateActivityProgress, 100);
                } else if (activity.created_at) {
                    activityTimeElement.style.display = 'flex';
                    activityProgressElement.style.display = 'none';
                    function updateActivityTime() {
                        const startTime = activity.created_at;
                        const elapsed = Math.floor((Date.now() - startTime) / 1000);
                        const hours = Math.floor(elapsed / 3600);
                        const minutes = Math.floor((elapsed % 3600) / 60);
                        const seconds = elapsed % 60;
                        let timeText = '';
                        if (hours > 0) {
                            timeText = `${hours}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                        } else {
                            timeText = `${minutes}:${seconds.toString().padStart(2, '0')}`;
                        }
                        activityCard.querySelector('.activity-time-text').textContent = timeText;
                    }
                    updateActivityTime();
                    activityIntervals[activity.id] = setInterval(updateActivityTime, 1000);
                }
                if (activity.buttons && activity.buttons.length > 0) {
                    const buttonsContainer = activityCard.querySelector('.activity-buttons');
                    activity.buttons.forEach(buttonText => {
                        const button = document.createElement('a');
                        button.className = 'activity-button';
                        let buttonUrl = '#';
                        if (activity.metadata && activity.metadata.button_urls) {
                            const buttonIndex = activity.buttons.indexOf(buttonText);
                            if (activity.metadata.button_urls[buttonIndex]) {
                                buttonUrl = activity.metadata.button_urls[buttonIndex];
                            }
                        } else if (activity.details_url && buttonText.toLowerCase().includes('listen') || buttonText.toLowerCase().includes('watch')) {
                            buttonUrl = activity.details_url;
                        }
                        button.href = buttonUrl;
                        button.target = '_blank';
                        button.textContent = buttonText;
                        buttonsContainer.appendChild(button);
                    });
                }
                activitiesContainer.appendChild(activityCard);
            });
        }

        async function handleIdSubmission() {
            const userIdInput = document.getElementById('userIdInput');
            const newUserId = userIdInput.value.trim();
            
            if (!newUserId || newUserId === currentUserId) {
                return;
            }
        
            try {
                await fetchDcdnData(newUserId);
                currentUserId = newUserId;
                connectWebSocket(newUserId);
            } catch (error) {
                console.error('Failed to fetch DCDN data:', error);
                showErrorToast('Invalid User ID');
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            const submitBtn = document.getElementById('submitBtn');
            const userIdInput = document.getElementById('userIdInput');
            
            fetchDcdnData(currentUserId); 
            connectWebSocket(currentUserId);
            
            submitBtn.addEventListener('click', handleIdSubmission);
            
            userIdInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    handleIdSubmission();
                }
            });
        });
    </script>
</body>
</html>
